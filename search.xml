<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>MySQL误操作后数据恢复（delete）</title>
      <link href="/2024/09/21/mysql-recover/"/>
      <url>/2024/09/21/mysql-recover/</url>
      
        <content type="html"><![CDATA[<h3 id="误删除数据恢复"><a href="#误删除数据恢复" class="headerlink" title="误删除数据恢复"></a>误删除数据恢复</h3><span id="more"></span><ul><li><p>把binglog解析为文本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog --no-defaults --base64-output=decode-rows -v -v ./mysql-bin.001250 &gt; mysql_bin_log.txt</span><br></pre></td></tr></table></figure><ul><li>如果确定时间范围，可以使用: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog --no-defaults --database=test_db --start-datetime=&quot;2024-09-12 00:00:00&quot; --stop-datetime=&quot;2024-09-13 00:00:00&quot; ./mysql-bin.001250 &gt; mysql_bin_log.txt</span><br></pre></td></tr></table></figure></li></ul></li><li><p>过滤出 <code>test_db.test_table</code> 的删除内容</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat mysql_bin_log.txt | sed -n &#x27;/### DELETE FROM `test_db`.`test_table`/,/COMMIT/p&#x27;</span><br></pre></td></tr></table></figure><p>  确认好之后，保存到文件中: </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat mysql_bin_log.txt | sed -n &#x27;/### DELETE FROM `test_db`.`test_table`/,/COMMIT/p&#x27; &gt;&gt; mysql_delete.txt</span><br></pre></td></tr></table></figure></li><li><p>把 DELETE 数据转换成 insert into 语句</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat table_delete.txt \</span><br><span class="line">| sed -n &#x27;/###/p&#x27; \</span><br><span class="line">| sed &#x27;s/### //g;s/\/\*.*/,/g;s/DELETE FROM/INSERT INTO/g;s/WHERE/SELECT/g;&#x27; \</span><br><span class="line">| gsed -r &#x27;s/(@22.*),/\1;/g&#x27; \</span><br><span class="line">| sed &#x27;s/@.*=//g&#x27; &gt; recovery.sql</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>   所以最后(4个sed)替换的操作为:<br>   * 只保留包含 ### 的行<br>   * 多重操作<br>       i. 删除每行的前缀注释 ###<br>       i. 删除 数据列 对应的 mysql注释<br>       i. 替换 DELETE FROM 为 INSERT INTO<br>       i. 替换 WHERE 为 SELECT<br>   * 按正则替换第 22 列(表一共22列)最后的 , 逗号为 ; 分号<br>   * 删除 数据列 的前缀, 只保留对应的数据</p></li><li><p>注意:</p><ul><li><p>gsed 是由于MAC系统自带的 sed 没有 -r 选项, 所以安装: <code>brew install gnu-sed</code></p></li><li><p><code>gsed -r &#39;s/(@17.*),/\1;/g&#39;</code> 中的 @17 其实是 test_table 表的最后一列</p></li></ul></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>client online 监听</title>
      <link href="/2022/08/22/websocket-online/"/>
      <url>/2022/08/22/websocket-online/</url>
      
        <content type="html"><![CDATA[<h3 id="用户状态监测"><a href="#用户状态监测" class="headerlink" title="用户状态监测"></a>用户状态监测</h3><p>根据client的ping消息，监听用户状态</p><h3 id="分时采集ping-消息"><a href="#分时采集ping-消息" class="headerlink" title="分时采集ping 消息"></a>分时采集ping 消息</h3><p>每隔5S，采集10S内的ping消息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">time_now, ms_delta, listen_list = int(time.time()), 0, []</span><br><span class="line">while ms_delta &lt; 10:</span><br><span class="line">    value = MQ.message</span><br><span class="line">    if value:</span><br><span class="line">        listen_list.append(value)</span><br><span class="line">    ms_delta = int(time.time()) - time_now</span><br><span class="line">func(listen_list)</span><br><span class="line">time.sleep(5)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里面有一个小技巧，采集10S内的ms，可以用时间差作为循环控制条件</p><h3 id="差值思想，获取未ping的客户端（下线状态）"><a href="#差值思想，获取未ping的客户端（下线状态）" class="headerlink" title="差值思想，获取未ping的客户端（下线状态）"></a>差值思想，获取未ping的客户端（下线状态）</h3><p>上述步骤获取当前10S内的ping消息，online_list</p><p>关键：通过redis获取上次前10S内的ping消息，last_online</p><ul><li>如果last_online为空，说明当前offline_list不存在。将当前的online_list存入到redis，并作为下次的last_online  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cache_key = &quot;&quot;</span><br><span class="line">   if not value_list:</span><br><span class="line">       redis_client.delete(cache_key)</span><br><span class="line"></span><br><span class="line">   with redis_client.pipeline() as pipe:</span><br><span class="line">       pipe.multi()</span><br><span class="line">       pipe.delete(cache_key)</span><br><span class="line">       pipe.sadd(cache_key, *value_list)</span><br><span class="line">       pipe.expireat(cache_key, expired_at)</span><br><span class="line">       pipe.execute()</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li>如果last_online不为空，则当前不在线状态为：<code>offline_list = last_online - online_list</code></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> websocket ping </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kafka-python debug log</title>
      <link href="/2021/12/03/kafka-python-disable-debug-log/"/>
      <url>/2021/12/03/kafka-python-disable-debug-log/</url>
      
        <content type="html"><![CDATA[<h4 id="python禁掉kafka-debug日志"><a href="#python禁掉kafka-debug日志" class="headerlink" title="python禁掉kafka debug日志"></a>python禁掉kafka debug日志</h4><p>django 中使用kafka，但kafka 的debug日志会无限输出到日志文件中，非常头痛。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INFO 2022-07-29 08:46:51,544 0cd0ec8c3b57480093f54a8907cb2a63 [base._handle_group_coordinator_response line:694] Discovered coordinator coordinator-0 for group g1</span><br><span class="line">WARNING 2022-07-29 08:46:51,544 0cd0ec8c3b57480093f54a8907cb2a63 [base.coordinator_dead line:716] Marking the coordinator dead (node coordinator-0) for group g1: Node Disconnected.</span><br><span class="line">WARNING 2022-07-29 08:46:51,544 2d9682ce3ecd4d0481e70f9acd8ebdf2 [base.coordinator_dead line:716] Marking the coordinator dead (node coordinator-0) for group g1: Node Disconnected.</span><br></pre></td></tr></table></figure><p>根本原因在于，kafka的python包中 <code>logger = logging.getLogger(&quot;kafka&quot;)</code><br>如果在django 的setting中没有定义 kafka 的logger，那会直接输出到 ROOT中。</p><p>解决方法也很简单，在setting的logging配置中配置下 kafka logger</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&quot;loggers&quot;: &#123;</span><br><span class="line">    &quot;kafka&quot;: &#123;</span><br><span class="line">        &quot;handlers&quot;: [&quot;console&quot;],</span><br><span class="line">        &quot;propagate&quot;: False,</span><br><span class="line">        &quot;level&quot;: &quot;WARNING&quot;,</span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>或者</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logging.getLogger(&quot;kafka&quot;).setLevel(logging.WARNING)</span><br></pre></td></tr></table></figure><p>日志level，看需求，一般是INFO，不像看到相关的kafka任何信息直接使用ERROR</p>]]></content>
      
      
      
        <tags>
            
            <tag> kafka </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginx log tar</title>
      <link href="/2020/02/22/nginx-log-tar/"/>
      <url>/2020/02/22/nginx-log-tar/</url>
      
        <content type="html"><![CDATA[<h3 id="shell-script"><a href="#shell-script" class="headerlink" title="shell script"></a>shell script</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">logroot=&quot;/usr/servers/nginx/logs&quot;</span><br><span class="line">hisroot=$logroot/log-history</span><br><span class="line">sudo mkdir -p $hisroot</span><br><span class="line">day=$(date &#x27;+%Y%m%d&#x27;)</span><br><span class="line">aclogname=&quot;$&#123;day&#125;-access.log&quot;</span><br><span class="line">erlogname=&quot;$&#123;day&#125;-error.log&quot;</span><br><span class="line">cat $logroot/api-access.log &gt; $hisroot/$aclogname</span><br><span class="line">cat $logroot/api-error.log &gt; $hisroot/$erlogname</span><br><span class="line">sudo truncate -s 0 $logroot/api-access.log</span><br><span class="line">sudo truncate -s 0 $logroot/api-error.log</span><br><span class="line"></span><br></pre></td></tr></table></figure><span id="more"></span><h3 id="crontab-命令"><a href="#crontab-命令" class="headerlink" title="crontab 命令"></a>crontab 命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">59 23 * * * /usr/servers/nginx/logs/log-tar.sh</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> linux-tips </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginx openresty</title>
      <link href="/2019/12/03/openresty/"/>
      <url>/2019/12/03/openresty/</url>
      
        <content type="html"><![CDATA[<h4 id="openresty-install"><a href="#openresty-install" class="headerlink" title="openresty install"></a>openresty install</h4><p><a href="https://blog.csdn.net/fyq201749/article/details/80981350">https://blog.csdn.net/fyq201749/article/details/80981350</a></p><span id="more"></span><h4 id="openresty-sample"><a href="#openresty-sample" class="headerlink" title="openresty sample"></a>openresty sample</h4><p>redirect.lua</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">local cjson = require &quot;cjson.safe&quot;</span><br><span class="line"></span><br><span class="line">local function read_from_file(file_name)</span><br><span class="line">  local f = assert(io.open(file_name, &quot;r&quot;))</span><br><span class="line">  local string = f:read(&quot;*all&quot;)</span><br><span class="line">  f:close()</span><br><span class="line">  return string</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">ngx.req.read_body()</span><br><span class="line">local body = ngx.req.get_body_data()</span><br><span class="line">ngx.log(ngx.INFO, &quot;params.\n&quot;, body, &quot;\n&quot;)</span><br><span class="line"></span><br><span class="line">if (body == nil) then</span><br><span class="line">  local body_file = ngx.req.get_body_file()</span><br><span class="line">  if body_file then</span><br><span class="line">    body = read_from_file(body_file)</span><br><span class="line">  else</span><br><span class="line">    ngx.status = 500</span><br><span class="line">    ngx.say(&quot;error&quot;)</span><br><span class="line">    return</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">local body_parameters, err = cjson.decode(ngx.req.get_body_data())</span><br><span class="line">if err then</span><br><span class="line"> body_parameters = &#123;&#125;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">if (&quot;keywords&quot; == body_parameters[&quot;keywords&quot;]) then</span><br><span class="line">  ngx.var.proxy_host=&quot;proxy_pass&quot;</span><br><span class="line">  ngx.var.proxy_http=&#x27;http&#x27;</span><br><span class="line">else</span><br><span class="line">  ngx.var.proxy_host=&quot;proxy_pass&quot;</span><br><span class="line">  ngx.var.proxy_http=&#x27;https&#x27;</span><br><span class="line">end</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>nginx config</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    set $proxy_host &#x27;&#x27;;</span><br><span class="line">    set $proxy_http &#x27;&#x27;;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    rewrite_by_lua_file /file_path/redirect.lua;</span><br><span class="line">    proxy_pass $proxy_http://$proxy_host;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> openresty </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginx web page 404</title>
      <link href="/2019/12/02/nginx-webpage-try_file/"/>
      <url>/2019/12/02/nginx-webpage-try_file/</url>
      
        <content type="html"><![CDATA[<h4 id="nginx-web-page-404"><a href="#nginx-web-page-404" class="headerlink" title="nginx web page 404"></a>nginx web page 404</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    root   /file_path;</span><br><span class="line">    index  index.html index.htm;</span><br><span class="line">    try_files $uri $uri/ @rewrites;</span><br><span class="line">&#125;</span><br><span class="line">location @rewrites &#123;rewrite ^(.+)$ /index/index.html last;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><span id="more"></span>]]></content>
      
      
      
        <tags>
            
            <tag> nginx-webpage </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux close_wait</title>
      <link href="/2019/06/22/linux-keepalive/"/>
      <url>/2019/06/22/linux-keepalive/</url>
      
        <content type="html"><![CDATA[<h3 id="前置环境"><a href="#前置环境" class="headerlink" title="前置环境"></a>前置环境</h3><ul><li>Azure</li><li>centos7.6</li><li>python3.6.5</li><li>tornado&#x3D;&#x3D;5.0.2</li><li>Tornado-MySQL&#x3D;&#x3D;0.5.1</li><li>tornado-redis&#x3D;&#x3D;2.4.18</li></ul><span id="more"></span><h3 id="事故场景"><a href="#事故场景" class="headerlink" title="事故场景"></a>事故场景</h3><p>最终的结果是浏览器所有的请求都是pending的状态。<br>通过<code>lsof -i:9000</code>查看: </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">python3 105792 apps    5u  IPv4 2782706      0t0  TCP *:cslistener (LISTEN)</span><br><span class="line">python3 105808 apps    5u  IPv4 2782706      0t0  TCP *:cslistener (LISTEN)</span><br><span class="line">python3 105808 apps    9u  IPv4 2791131      0t0  TCP localhost:cslistener-&gt;localhost:57550 (CLOSE_WAIT)</span><br><span class="line">python3 105809 apps    5u  IPv4 2782706      0t0  TCP *:cslistener (LISTEN)</span><br><span class="line">python3 105809 apps    9u  IPv4 2791129      0t0  TCP localhost:cslistener-&gt;localhost:57548 (CLOSE_WAIT)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>2个worker进程已经是CLOSE_WAIT的状态了。</p><h3 id="事故解决"><a href="#事故解决" class="headerlink" title="事故解决"></a>事故解决</h3><p>I. Updating Linux</p><p>For a Linux client, there are four operating system keepalive parameters to change:</p><ul><li><p><code>tcp_keepalive_probes</code> - the number of probes that are sent and unacknowledged before the client considers the connection broken and notifies the application layer</p></li><li><p><code>tcp_keepalive_time</code> - the interval between the last data packet sent and the first keepalive probe</p></li><li><p><code>tcp_keepalive_intvl</code> - the interval between subsequent keepalive probes</p></li><li><p><code>tcp_retries2</code> - the maximum number of times a packet is retransmitted before giving up</p></li></ul><p>II. On the Linux operating system, update these parameters using the “echo” command:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;60&quot; &gt; /proc/sys/net/ipv4/tcp_keepalive_time</span><br><span class="line">echo &quot;1&quot; &gt; /proc/sys/net/ipv4/tcp_keepalive_intvl</span><br><span class="line">echo &quot;10&quot; &gt; /proc/sys/net/ipv4/tcp_keepalive_probes</span><br><span class="line">echo &quot;3&quot; &gt; /proc/sys/net/ipv4/tcp_retries2</span><br></pre></td></tr></table></figure><p>The <code>tcp_keepalive_time</code> and <code>tcp_keepalive_intvl</code> values are expressed in seconds. To retain these values after a system restart, they must be added to the <code>/etc/sysctl.conf</code> file.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_keepalive_time = 60</span><br><span class="line">net.ipv4.tcp_keepalive_intvl = 1</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 10</span><br><span class="line">net.ipv4.tcp_retries2 = 3</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="注"><a href="#注" class="headerlink" title="注"></a>注</h3><p>worker出现CLOSE_WAIT，问题一定在代码部分。tornado mysql缺少快速失败机制，始终是一个坑。重构代码，需要集中的时间。更改系统参数，是一个缓冲方案。</p>]]></content>
      
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GitLab Community Edition</title>
      <link href="/2019/05/12/gitlab-community/"/>
      <url>/2019/05/12/gitlab-community/</url>
      
        <content type="html"><![CDATA[<p>注：<a href="https://gitlab.com/help/raketasks/backup_restore.md">gitlab 备份、恢复、迁移</a></p><span id="more"></span><h3 id="docker-compose-yml"><a href="#docker-compose-yml" class="headerlink" title="docker-compose.yml"></a>docker-compose.yml</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">version: &#x27;3.6&#x27;</span><br><span class="line">services:</span><br><span class="line">  gitlab:</span><br><span class="line">    container_name: gitlab</span><br><span class="line">    image: gitlab/gitlab-ce:latest</span><br><span class="line">    restart: always</span><br><span class="line">    environment:</span><br><span class="line">      GITLAB_OMNIBUS_CONFIG: |</span><br><span class="line">            external_url &#x27;http://gitlab.deno.vip&#x27;</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;80:80&quot;</span><br><span class="line">      - &quot;443:443&quot;</span><br><span class="line">      - &quot;22:22&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - &quot;/data/gitlab/config:/etc/gitlab&quot;</span><br><span class="line">      - &quot;/data/gitlab/logs:/var/log/gitlab&quot;</span><br><span class="line">      - &quot;/data/gitlab/data:/var/opt/gitlab&quot;</span><br></pre></td></tr></table></figure><ul><li>&#x2F;data 最好是数据盘挂载路径</li><li>gitlab与宿主机ssh端口最好设置为非22，当然迁移除外。</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> centos-gitlab </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Let&#39;s Encrypt SSL证书</title>
      <link href="/2019/03/22/let-encrypt/"/>
      <url>/2019/03/22/let-encrypt/</url>
      
        <content type="html"><![CDATA[<p>备注：<a href="https://zhuanlan.zhihu.com/p/24996258">Let’s Encrypt SSL证书安装教程</a></p><h4 id="事故场景"><a href="#事故场景" class="headerlink" title="事故场景"></a>事故场景</h4><p>通过certbot安装Let’s Encrypt https证书，在安卓手机的微信小程序中报错：<code>wx.request:fail ssl hand shake error</code></p><span id="more"></span><h4 id="证书鉴定"><a href="#证书鉴定" class="headerlink" title="证书鉴定"></a>证书鉴定</h4><p>通过<a href="https://www.myssl.cn/tools/check-server-cert.html">SSL服务器证书安装检查器</a><br>检查证书发现</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">证书2</span><br><span class="line">证书使用者：Let&#x27;s Encrypt Authority X3</span><br><span class="line">证书颁发者：ISRG Root X1</span><br><span class="line">有效期：从 2016/10/6 到 2021/10/6</span><br><span class="line">签名算法：sha256RSA</span><br><span class="line">公钥长度：2048位 (RSA 算法)</span><br><span class="line">SHA1指纹：1b 23 67 53 54 fc ad 90 11 9d 88 07 50 15 ea 17 ad d5 27 d8</span><br><span class="line">SHA256指纹：73 1d 3d 9c fa a0 61 48 7a 1d 71 44 5a 42 f6 7d f0 af ca 2a 6c 2d 2f 98 ff 7b 3c e1 12 b1 f5 68</span><br><span class="line">证书来源：缺失证书</span><br><span class="line">状态：错误： 服务器缺少中间证书</span><br></pre></td></tr></table></figure><h4 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h4><p>通过<a href="https://www.myssl.cn/tools/downloadchain.html">获取证书信息 及 下载中间证书</a>将letsencrypt证书cert1.pem生成中间证书文件chain.crt下载下来，打开中间证书文件chain.crt将里面的内容追加到fullchain1.pem，保存。解决问题。</p>]]></content>
      
      
      
        <tags>
            
            <tag> https </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>django-docker镜像实践</title>
      <link href="/2018/11/25/linux-docker/"/>
      <url>/2018/11/25/linux-docker/</url>
      
        <content type="html"><![CDATA[<h4 id="linux-server安装docker-ce"><a href="#linux-server安装docker-ce" class="headerlink" title="linux server安装docker ce"></a>linux server安装docker ce</h4><p>参考：<a href="https://yq.aliyun.com/articles/110806?spm=5176.8351553.0.0.37161991kq7Vrm">阿里云安装Docker CE</a><br>推荐手动安装，按需决定是否更改镜像源。</p><span id="more"></span><h4 id="linux-server安装docker-compose"><a href="#linux-server安装docker-compose" class="headerlink" title="linux server安装docker-compose"></a>linux server安装docker-compose</h4><p>centos 安装docker-compose，建议通过pip安装。当然亦可以直接下载，安装docker-compose注意版本。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -L https://github.com/docker/compose/releases/download/1.13.0/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure><h4 id="镜像打包"><a href="#镜像打包" class="headerlink" title="镜像打包"></a>镜像打包</h4><ul><li>本地下载镜像 <code>docker pull centos</code></li><li>创建项目Dockerfile  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM centos</span><br><span class="line">RUN mkdir -p /apps/web/leetee</span><br><span class="line">ADD . /apps/web/leetee</span><br></pre></td></tr></table></figure></li><li>进入容器 <code>docker run -it dockerimage_id /bin/bash</code></li><li>容器内部安装项目需要的环境，创建非root用户，并设置权限。requirements.txt<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">amqp==2.3.2</span><br><span class="line">anyjson==0.3.3</span><br><span class="line">appnope==0.1.0</span><br><span class="line">backcall==0.1.0</span><br><span class="line">billiard==3.5.0.4</span><br><span class="line">celery==4.2.0</span><br><span class="line">certifi==2018.4.16</span><br><span class="line">chardet==3.0.4</span><br><span class="line">decorator==4.3.0</span><br><span class="line">Django==2.0.4</span><br><span class="line">django-extensions==2.1.3</span><br><span class="line">django-grappelli==2.12.1</span><br><span class="line">djangorestframework==3.8.2</span><br><span class="line">docutils==0.14</span><br><span class="line">gevent==1.3.7</span><br><span class="line">greenlet==0.4.15</span><br><span class="line">idna==2.6</span><br><span class="line">ipython==6.4.0</span><br><span class="line">ipython-genutils==0.2.0</span><br><span class="line">jedi==0.12.0</span><br><span class="line">kombu==4.2.0</span><br><span class="line">meld3==1.0.2</span><br><span class="line">parso==0.2.1</span><br><span class="line">pexpect==4.6.0</span><br><span class="line">pickleshare==0.7.4</span><br><span class="line">Pillow==5.3.0</span><br><span class="line">prompt-toolkit==1.0.15</span><br><span class="line">ptyprocess==0.5.2</span><br><span class="line">Pygments==2.2.0</span><br><span class="line">pytz==2018.4</span><br><span class="line">redis==2.10.6</span><br><span class="line">requests==2.18.4</span><br><span class="line">simplegeneric==0.8.1</span><br><span class="line">simplejson==3.16.0</span><br><span class="line">six==1.11.0</span><br><span class="line">supervisor==4.0.0.dev0</span><br><span class="line">traitlets==4.3.2</span><br><span class="line">urllib3==1.22</span><br><span class="line">uWSGI==2.0.17.1</span><br><span class="line">uwsgitop==0.10</span><br><span class="line">vine==1.1.4</span><br><span class="line">wcwidth==0.1.7</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li>删除项目文件 <code>rm -rf /apps/web/leetee/*</code></li><li>镜像打包 <code>docker commit -a &#39;.&#39; -m &#39;.&#39; container_id shllmoon/leetee</code></li><li>镜像上传 <code>docker push shllmoon/leetee</code></li></ul><h4 id="镜像生成"><a href="#镜像生成" class="headerlink" title="镜像生成"></a>镜像生成</h4><ul><li><p>个人使用的是docker官方地址<code>https://registry.docker-cn.com</code>。镜像源：<code>shllmoon/leetee</code></p></li><li><p>uwsgi.ini文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[uwsgi]</span><br><span class="line">chdir=/apps/web/leetee</span><br><span class="line">module=leetee.wsgi</span><br><span class="line">socket=0.0.0.0:8000</span><br><span class="line">chmod-socket=666</span><br><span class="line">gevent=100</span><br><span class="line">max-requests=2000</span><br><span class="line">master=true</span><br><span class="line">workers=2</span><br><span class="line">pidfile=/apps/web/data/uwsgi-leetee.pid</span><br><span class="line">stats=/apps/web/data/sock-leetee.backend.sock</span><br><span class="line">disable-logging=true</span><br><span class="line">vacuum=true</span><br></pre></td></tr></table></figure></li><li><p>supervisord.conf文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[program:django]</span><br><span class="line">directory=/apps/web/leetee</span><br><span class="line">command=/apps/python3/bin/uwsgi --ini /apps/web/leetee/uwsgi.ini</span><br><span class="line">priority=1</span><br><span class="line">numprocs=1</span><br><span class="line">autostart=true</span><br><span class="line">startsecs=3</span><br><span class="line">autorestart=unexpected</span><br><span class="line">exitcodes=0</span><br><span class="line">;redirect_stderr=true</span><br><span class="line">stdout_logfile_maxbytes=500MB</span><br><span class="line">stdout_logfile_backups=20</span><br><span class="line">stderr_logfile=/apps/web/data/logs/web.log</span><br><span class="line">stdout_logfile=/apps/web/data/logs/web.log</span><br><span class="line"></span><br><span class="line">[group:web_server]</span><br><span class="line">programs=django</span><br><span class="line"></span><br><span class="line">[unix_http_server]</span><br><span class="line">file=/apps/web/data/supervisor.sock</span><br><span class="line">chmod=0777</span><br><span class="line">username=apps</span><br><span class="line">password=apps123</span><br><span class="line"></span><br><span class="line">[supervisord]</span><br><span class="line">logfile=/apps/web/data/logs/supervisord_shop_log.log</span><br><span class="line">stderr_logfile=/apps/web/data/logs/supervisord_err.log</span><br><span class="line">stdout_logfile=/apps/web/data/logs/supervisord_out.log</span><br><span class="line">pidfile=/apps/web/data/supervisord.pid</span><br><span class="line"></span><br><span class="line">[supervisorctl]</span><br><span class="line">serverurl=unix:///apps/web/data/supervisor.sock</span><br><span class="line"></span><br><span class="line">[rpcinterface:supervisor]</span><br><span class="line">supervisor.rpcinterface_factory=supervisor.rpcinterface:make_main_rpcinterface</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>Dockerfile文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FROM shllmoon/leetee</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>docker-compose.yml文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">version: &#x27;2&#x27;</span><br><span class="line">services:</span><br><span class="line">  python:</span><br><span class="line">    build: .</span><br><span class="line">    privileged: true</span><br><span class="line">    user: ubuntu</span><br><span class="line"></span><br><span class="line">    ports:</span><br><span class="line">      - &quot;8000:8000&quot;</span><br><span class="line"></span><br><span class="line">    volumes:</span><br><span class="line">      - &quot;/apps/web/www/leetee/leetee:/apps/web/leetee&quot;</span><br><span class="line">      - &quot;/apps/web/www/leetee/logs:/apps/web/data/logs&quot;</span><br><span class="line"></span><br><span class="line">    command: &quot;/apps/python3/bin/supervisord -n -c /apps/web/leetee/supervisord.conf&quot;</span><br><span class="line">    restart: always</span><br></pre></td></tr></table></figure></li></ul><p>ps：<br>使用该镜像需要注意：</p><ol><li>系统存在ubuntu用户，并且ubuntu用户的uid和gid都为500  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">usermod -u 500 ubuntu</span><br><span class="line">groupmod -g 500 ubuntu</span><br></pre></td></tr></table></figure></li><li>ubuntu用户需要有写log目录的权限 <code>sudo chown -R ubuntu:ubuntu /apps/web/www/leetee/logs</code></li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> centos-docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>centos 安装mysql</title>
      <link href="/2018/03/22/centos-mysql/"/>
      <url>/2018/03/22/centos-mysql/</url>
      
        <content type="html"><![CDATA[<p>注：该文档只适用centos7以下（不包括centos7），安装mysql5.6。文档中的mysql5.6相对于mysql5.7存在一些意想不到的问题。比如int类型的获取到undefined会被mysql处理成default值。</p><h4 id="检测系统是否安装mysql"><a href="#检测系统是否安装mysql" class="headerlink" title="检测系统是否安装mysql"></a>检测系统是否安装mysql</h4><p><code>yum list installed | grep mysql</code></p><h4 id="安装mysql安装包"><a href="#安装mysql安装包" class="headerlink" title="安装mysql安装包"></a>安装mysql安装包</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://repo.mysql.com/mysql-community-release-el6-5.noarch.rpm</span><br><span class="line">rpm -ivh mysql-community-release-el6-5.noarch.rpm</span><br></pre></td></tr></table></figure><span id="more"></span><h4 id="查看可安装的mysql列表"><a href="#查看可安装的mysql列表" class="headerlink" title="查看可安装的mysql列表"></a>查看可安装的mysql列表</h4><p><code>yum list|grep mysql</code>选择需要安装，一般只需要安装client和server即可。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install mysql-community-server.x86_64 -y</span><br><span class="line">sudo yum install mysql-community-client.x86_64 -y</span><br></pre></td></tr></table></figure><h4 id="启动mysql"><a href="#启动mysql" class="headerlink" title="启动mysql"></a>启动mysql</h4><p><code>service mysqld start</code></p><h4 id="mysql设置密码"><a href="#mysql设置密码" class="headerlink" title="mysql设置密码"></a>mysql设置密码</h4><p>mysql刚刚安装完的时候，root用户的密码默认是空的。需要用mysql的root用户登录，并修改密码：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p</span><br><span class="line">use mysql;</span><br><span class="line">update user set password=PASSWORD(&quot;输入root用户密码&quot;) where User=&#x27;root&#x27;;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure><h4 id="查看mysql是否自启动-并且设置开启自启动"><a href="#查看mysql是否自启动-并且设置开启自启动" class="headerlink" title="查看mysql是否自启动,并且设置开启自启动"></a>查看mysql是否自启动,并且设置开启自启动</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --list | grep mysqld</span><br><span class="line">chkconfig mysqld on</span><br></pre></td></tr></table></figure><h4 id="mysql安全设置"><a href="#mysql安全设置" class="headerlink" title="mysql安全设置"></a>mysql安全设置</h4><p><code>mysql_secure_installation</code></p><p>ps：在mysql安全设置中，不要允许root用户远程登陆。</p><h4 id="mysql设置远程登陆用户"><a href="#mysql设置远程登陆用户" class="headerlink" title="mysql设置远程登陆用户"></a>mysql设置远程登陆用户</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GRANT ALL PRIVILEGES ON *.* TO admin@&quot;%&quot; IDENTIFIED BY &#x27;password123&#x27; WITH GRANT OPTION;</span><br><span class="line">update db set host = &#x27;%&#x27; where user = &#x27;admin&#x27;;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> centos-mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux小操作集锦</title>
      <link href="/2017/09/24/linux-tips/"/>
      <url>/2017/09/24/linux-tips/</url>
      
        <content type="html"><![CDATA[<h3 id="root密码修改"><a href="#root密码修改" class="headerlink" title="root密码修改"></a>root密码修改</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">chattr -i /etc/passwd</span><br><span class="line">chattr -i /etc/shadow</span><br><span class="line">passwd root</span><br><span class="line">chattr +i /etc/passwd</span><br><span class="line">chattr +i /etc/shadow</span><br></pre></td></tr></table></figure><span id="more"></span><p>1出现permission问题时，执行<code>mount / -rw -o remount</code>即可完成root密码修改。</p><p>当然这里面的操作都是在recovery(root)模式下进行的。</p><h3 id="linux-ssh不带密码"><a href="#linux-ssh不带密码" class="headerlink" title="linux ssh不带密码"></a>linux ssh不带密码</h3><p><code>ssh apps@ip</code>一般出现：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apps@ip: Permission denied (publickey,gssapi-keyex,gssapi-with-mic)</span><br></pre></td></tr></table></figure><p>这种信息。直接的原因是server上apps用户的 authorized_keys权限不够。</p><p>解决方法：在server 上，用apps 执行：<code>chmod 644 ~/.ssh/authorized_keys</code></p><p>另附：<br>linux清除用户密码：root下执行： <code>passwd -d apps</code></p><h3 id="linux-oh-my-zsh"><a href="#linux-oh-my-zsh" class="headerlink" title="linux oh-my-zsh"></a>linux oh-my-zsh</h3><p>server中，以root方式login，按照上面的链接无法生效。<br>只是因为没有<code>/root/.zshrc</code>文件，最直接的解决方法：<br><code>cp /root/.oh-my-zsh/templates/zshrc.zsh-template /root/.zshrc</code></p><p>ps：zsh切换到<code>bash-exec bash</code></p><h3 id="linux-查看本机外网IP"><a href="#linux-查看本机外网IP" class="headerlink" title="linux 查看本机外网IP"></a>linux 查看本机外网IP</h3><ol><li><code>curl cip.cc</code></li><li><code>curl ifconfig.me</code></li></ol><h3 id="mysql-data"><a href="#mysql-data" class="headerlink" title="mysql data"></a>mysql data</h3><p>mysql 在用source导入数据时，中文乱码。解决方案：<br><code>mysql -uroot -p --default-character-set=utf8</code></p>]]></content>
      
      
      
        <tags>
            
            <tag> linux-tips </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用git做服务器端代码的部署</title>
      <link href="/2017/09/23/git-deploy/"/>
      <url>/2017/09/23/git-deploy/</url>
      
        <content type="html"><![CDATA[<h3 id="server-准备工作："><a href="#server-准备工作：" class="headerlink" title="server 准备工作："></a>server 准备工作：</h3><p>  这些工作都在root或有管理权限的帐号下进行，下面以root为用户，切换到其他用户的时候会提示</p><span id="more"></span><p>  确保安装了git</p><p>  为了安全起见，新建一个专门用于代码部署的无特权用户<br>    <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">useradd -m apps</span><br><span class="line">passwd apps //设置该用户的密码，也可根据喜好配置成免密码登陆</span><br><span class="line"></span><br></pre></td></tr></table></figure></p><p>  新建一个目录作为要部署代码的根目录。<br>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /apps/web/www/git</span><br><span class="line">mkdir -p /apps/web/www/html</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>  这里建立git目录和html目录，是为了将代码和.git分离出来。<br>  在nginx的root中，直接设置<code>/apps/web/www/html</code>就不用担心.git之类的问题了。</p><p>  将这个目录的属主和属组都改为上面新建的用户apps<br>    <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /apps/web/www</span><br><span class="line">chown apps:apps git</span><br></pre></td></tr></table></figure></p><p>  切换到部署代码的专用用户<code>su apps</code></p><p>  进入项目根目录，初始化为git仓库<br>    <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /apps/web/www/git</span><br><span class="line">git init</span><br></pre></td></tr></table></figure></p><p>  注意：这里千万不要用<code>git --bare init</code>，一旦使用后续的<code>git checkout -f</code>是检不出来代码的。</p><p>  【重要】让仓库接受代码提交<br>    <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git config receive.denyCurrentBranch ignore</span><br><span class="line">git config core.worktree /apps/web/www/html</span><br><span class="line">git config --bool receive.denyNonFastForwards false  //禁止强制推送</span><br></pre></td></tr></table></figure></p><p>至此，一个空的git仓库就在服务器上建好了，仓库的地址为：<br><code>ssh://apps@ip/apps/web/www/git/.git</code></p><h3 id="local-准备工作："><a href="#local-准备工作：" class="headerlink" title="local 准备工作："></a>local 准备工作：</h3><p>   通过<code>git clone</code>或<code>git pull</code>从github或gitlab仓库上将代码拉取到本地</p><p>   将服务器添加到远程仓库列表，使用名字来区分不同的服务器，如服务器可以叫做server</p><p>   <code>git remote add server ssh://apps@ip/apps/web/www/git/.git</code></p><p>   将本地代码提交到测试服务器上面</p><p>   <code>git push server master</code></p><h3 id="server-操作："><a href="#server-操作：" class="headerlink" title="server 操作："></a>server 操作：</h3><p>   更新server，git仓库状态并检出文件</p>   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /apps/web/html/git</span><br><span class="line">git update-server-info</span><br><span class="line">git checkout -f</span><br></pre></td></tr></table></figure><p>   检查是不是将文件更新进来了<code>git status</code></p><p>   设置服务器端更新hook：post-update<br>   <code>cd .git/hooks</code><br>   新建 post-receive 或将 post-receive.sample 重命名为post-receive<code>touch post-receive</code>或则<br>   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv post-receive.sample post-receive</span><br><span class="line">vim post-receive</span><br></pre></td></tr></table></figure><br>   将如下内容复制到文件中：<br>   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">unset GIT_DIR</span><br><span class="line">cd ..</span><br><span class="line">git checkout -f</span><br></pre></td></tr></table></figure></p><p>注: 第3步的操作将post-receive 替换为 post-update也可以，<br>不过需要先将post-update中的<code>exec git update-server-info</code>这一行删掉</p><h3 id="后续代码的更新："><a href="#后续代码的更新：" class="headerlink" title="后续代码的更新："></a>后续代码的更新：</h3><p>   github 有更新的时候pull更新local</p><p>   然后本地先push到test-server进行测试</p><p>   然后在本地测试，测试通过之后push到prd上线</p><p>   代码的回滚：</p><ul><li>服务器端回滚：推荐<code>git reset --hard HEAD^</code></li><li>本地仓库回滚：无需登陆服务器即可实现代码回滚，<code>git reset HEAD^</code>保留代码回滚，</li></ul><p>   使用<code>git push remote_name local_branch_name -f</code> 强制推送</p><h3 id="使用过程中需要注意的问题："><a href="#使用过程中需要注意的问题：" class="headerlink" title="使用过程中需要注意的问题："></a>使用过程中需要注意的问题：</h3><ul><li>需要约定好git不能更新的操作要怎么处理，比如新增数据库的字段，新安装必要的扩展等</li><li>充分利用好git的hook功能，比如pre-commit可用于提交代码前进行单元测试等，但是hook做的操作要尽量简单</li></ul><h3 id="git其他操作"><a href="#git其他操作" class="headerlink" title="git其他操作"></a>git其他操作</h3><p>存储当前的版本号，如：<code>git log –pretty -1 | awk ‘/^commit/&#123;print $2&#125;’</code></p>]]></content>
      
      
      
        <tags>
            
            <tag> git-deploy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git单操作集锦</title>
      <link href="/2017/09/22/git-tips/"/>
      <url>/2017/09/22/git-tips/</url>
      
        <content type="html"><![CDATA[<h3 id="git-合并单个文件"><a href="#git-合并单个文件" class="headerlink" title="git 合并单个文件"></a>git 合并单个文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -p master account/api/views.py</span><br></pre></td></tr></table></figure><h3 id="git-本地忽略跟踪"><a href="#git-本地忽略跟踪" class="headerlink" title="git 本地忽略跟踪"></a>git 本地忽略跟踪</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git update-index --assume-unchanged /path/to/file</span><br></pre></td></tr></table></figure><span id="more"></span>]]></content>
      
      
      
        <tags>
            
            <tag> linux-tips </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>人际交往能力：远比你想象的重要</title>
      <link href="/2017/09/21/communication/"/>
      <url>/2017/09/21/communication/</url>
      
        <content type="html"><![CDATA[<h3 id="需要特别留意的点："><a href="#需要特别留意的点：" class="headerlink" title="需要特别留意的点："></a>需要特别留意的点：</h3><span id="more"></span><ul><li><p>每个人都希望感到自己很重要</p><ul><li>轻率地否决同事的想法，往往会起反效果。</li></ul></li><li><p>换位思考</p><ol><li>一个产品的自我修养，思考对他人而言什么才是最重要，什么才是他们需要的。</li><li>解决需求或提升效率的表述，一定比所谓的建议或经验更有说服力。</li></ol></li><li><p>减少争执</p><ul><li>注意区分争执和辩论。争执中，任何逻辑都不足以说服人。退一步，有时候可能会赢得不可估量的尊重。</li></ul></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> Interpersonal communication </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
